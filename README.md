# 警情链区块链系统

警情链系统是一个基于区块链技术的警情数据管理系统，旨在提高警情数据的可信度、透明度和安全性。该系统将警情数据上链存储，通过智能合约实现数据的不可篡改和可验证性，同时结合IPFS分布式存储系统保存关联文件。

## 快速开始

### 方法一：使用启动脚本

我们提供了一个方便的启动脚本，可以快速初始化系统并启动应用：

1. 安装依赖:
   ```
   pip install -r requirements.txt
   ```

2. 初始化系统（首次运行时执行）:
   ```
   python start.py --init
   ```

3. 启动应用:
   ```
   python start.py
   ```

4. 访问应用:
   - 主应用: http://localhost:5000
   - 数据可视化大屏: http://localhost:5000/data_view/demo

### 方法二：手动安装与配置

请参考下方的详细安装指南。

## 主要功能

- **警情数据上链**: 将警情记录通过智能合约保存到区块链上，确保数据不可篡改
- **PDF文档生成**: 自动根据警情数据生成标准化的PDF文档
- **IPFS分布式存储**: 使用IPFS保存PDF文档，实现分布式存储
- **默克尔树验证**: 使用默克尔树对数据进行哈希验证，确保数据完整性
- **区块链验证**: 通过智能合约验证警情记录的真实性和有效性
- **撤销机制**: 支持在必要时撤销警情记录，同时保留撤销记录
- **审计跟踪**: 记录系统中的所有关键操作，提供完整的审计轨迹
- **数据可视化**: 提供警情数据的可视化大屏，展示警情记录、上链情况等数据统计

## 技术栈

- **后端**: Flask (Python)
- **区块链**: 以太坊
- **智能合约**: Solidity
- **分布式存储**: IPFS
- **Web3交互**: Web3.py
- **PDF生成**: ReportLab, PyPDF2
- **数据库**: SQLite
- **数据可视化**: ECharts

## 系统架构

系统由以下几个核心模块组成:

1. **区块链模块 (PoliceBlockchain.py)**:
   - 管理与区块链的交互
   - 部署和调用智能合约

2. **智能合约模块 (contracts/)**:
   - PoliceRecordContract.sol: 管理警情记录的存储、验证和撤销
   - AuditTrailContract.sol: 管理系统操作的审计跟踪

3. **合约管理模块 (contract_manager.py)**:
   - 智能合约的编译、部署和交互
   - 提供统一的API调用合约功能

4. **数据上传模块 (PoliceDataUpload.py)**:
   - 处理CSV格式的警情数据
   - 生成PDF文档
   - 计算哈希值
   - 上传数据到区块链和IPFS

5. **数据验证模块 (PoliceDataVerification.py)**:
   - 验证警情数据的真实性和完整性
   - 校验默克尔树哈希

6. **Web界面模块 (views.py)**:
   - 提供用户交互界面
   - 处理用户请求

7. **IPFS工具模块 (ipfs_utils.py)**:
   - 管理与IPFS的交互
   - 上传和下载文件

8. **数据可视化模块 (data_view/)**:
   - 提供警情数据可视化大屏展示
   - 实时连接数据库，展示警情统计、上链情况等数据

## 安装指南

### 前提条件

- Python 3.8+
- 以太坊节点 (Ganache或Geth)
- IPFS节点 (可选，系统会在缺少IPFS时使用模拟模式)
- Solidity编译器 (solc 0.8.x)

### 安装步骤

1. 克隆仓库:
   ```
   git clone https://github.com/your-repo/PoliceChainSystem.git
   cd PoliceChainSystem
   ```

2. 创建并激活虚拟环境 (可选但推荐):
   ```
   python -m venv venv
   # Windows
   venv\Scripts\activate
   # Linux/MacOS
   source venv/bin/activate
   ```

3. 安装依赖:
   ```
   pip install -r requirements.txt
   ```

4. 安装Solidity编译器 (如果尚未安装):
   ```
   pip install solc-select
   solc-select install 0.8.17
   solc-select use 0.8.17
   ```

5. 启动本地以太坊节点 (如使用Ganache):
   ```
   # 如果使用Ganache GUI，直接启动应用
   # 如果使用命令行版本:
   ganache-cli
   ```

6. (可选) 启动IPFS守护进程:
   ```
   ipfs daemon
   ```

7. 初始化数据库:
   ```
   python init_db.py
   ```

8. 部署智能合约:
   ```
   python deploy_contracts.py
   ```

9. 启动应用:
   ```
   python app.py
   ```

## 使用指南

### 数据上传

1. 在Web界面选择"上传数据"
2. 上传符合格式的CSV文件 (参见sample_data.csv作为示例)
3. 系统将自动:
   - 生成PDF文档
   - 计算哈希值
   - 上传文件到IPFS
   - 将记录通过智能合约保存到区块链

### 数据验证

1. 在Web界面选择"验证数据"
2. 输入警情编号或上传PDF文件
3. 系统将验证:
   - 数据在区块链上的存在性
   - 数据的完整性 (通过哈希值比对)
   - 数据的状态 (是否已撤销)

### 数据撤销

1. 在Web界面选择"撤销记录"
2. 输入警情编号和撤销原因
3. 系统将通过智能合约记录撤销操作
4. 撤销记录将被永久保存在区块链上

### 数据可视化

1. 登录系统后在首页点击"查看数据大屏"按钮
2. 系统将显示一个基于实时数据的可视化大屏，包括：
   - 警情记录总数和已上链数量统计
   - 警情处理结果分布图
   - 警情地区分布图
   - 近期警情时间趋势
   - 警情地区排行榜
   - 各地区警情上链率

#### 数据可视化大屏详细说明

数据可视化大屏是本系统的核心功能之一，提供了对警情数据的全面分析和展示。具体包括：

**1. 实时数据统计**
- **警情记录总数**：显示系统中所有警情记录的总数量
- **警情上链总数**：显示已成功上链到区块链的警情记录数量

**2. 多维度数据分析**
- **行业分布**：通过环形饼图展示不同行业警情分布情况
- **省份分布**：通过横向条形图展示各省份警情数量分布
- **警情记录状态**：通过饼图展示各状态（活跃、已撤销、处理中、已完成）的记录数量
- **上链率排名**：通过横向条形图展示各地区警情记录的区块链上链率
- **时间趋势分析**：通过双线图展示近15天内的警情记录总数和上链记录数的变化趋势

**3. 实时更新机制**
- 系统每30秒自动从后台API获取最新数据
- 数据变化时会通过平滑动画展示变化过程
- 计数器数字变化采用动画效果，提升视觉体验

**4. 使用技巧**
- 将鼠标悬停在图表上可查看详细数据
- 点击图例可以切换显示/隐藏对应数据系列
- 图表支持缩放和自适应，在不同屏幕尺寸下都能良好展示

**5. 健康检查**
- 访问 `/data_view/api/ping` 端点可以检查数据API服务是否正常运行

## 智能合约

本系统使用两个主要的智能合约:

### PoliceRecordContract

负责警情记录的管理，包括:

- 添加新的警情记录
- 验证警情记录的真实性和完整性
- 撤销警情记录
- 查询警情记录

### AuditTrailContract

负责系统操作的审计跟踪，包括:

- 记录系统中的重要操作
- 查询审计记录
- 获取最近的审计记录

## 审计功能

### 审计跟踪模块

审计跟踪模块是本系统的重要安全功能，用于记录和跟踪系统中的所有关键操作。此功能基于区块链技术实现，确保审计记录不可篡改，为系统操作提供完整的可追溯性。

#### 主要功能

1. **记录系统操作**: 自动记录系统中的关键操作，包括：
   - 警情数据上链
   - 警情数据验证
   - 警情数据撤销
   - 用户登录/登出
   - 其他重要操作

2. **查询审计记录**: 提供便捷的审计记录查询功能：
   - 通过ID查询单条审计记录
   - 查询最近的n条审计记录
   - 查看审计记录的详细信息

3. **区块链保障**: 所有审计记录通过智能合约保存在区块链上，具有：
   - 不可篡改性
   - 时间戳证明
   - 操作者身份认证

#### 使用方法

1. 在导航菜单中点击"审计记录"进入审计查询页面
2. 可以通过记录ID查询特定记录，或查询最近的记录
3. 系统会自动记录用户的关键操作，无需手动操作

#### 技术实现

- 前端使用AuditTrailManager类管理审计记录操作
- 后端通过智能合约API将审计记录保存到区块链
- 审计记录包含操作用户、操作类型、详细信息和时间戳

## 开发指南

### 添加新功能

如需添加新功能，请遵循以下步骤:

1. 更新智能合约 (如果需要)
2. 在contract_manager.py中添加新的函数
3. 更新相关模块以使用新功能
4. 添加适当的测试

### 测试

运行测试脚本以验证系统功能:

```
python deploy_contracts.py  # 测试智能合约
python test_csv.py  # 测试CSV数据处理
python test_upload_chain.py  # 测试上链功能
```

### 数据可视化模块开发与定制

如需对数据可视化模块进行开发和定制：

1. 前端可视化页面位于 `data_view/templates/demo.html`
2. 后端数据API位于 `data_view/app.py` 中的 `get_data()` 函数
3. 添加新的可视化图表步骤：
   - 在HTML中添加新的图表容器
   - 在JavaScript中初始化新图表
   - 更新API返回数据结构以包含新图表所需数据
   - 在updateCharts函数中添加新图表的配置和数据绑定

4. 自定义主题样式：
   - 修改CSS样式定义
   - 更新chartTheme对象以调整全局图表样式

5. 添加新的API端点:
   - 在`data_view/app.py`中添加新的路由函数
   - 确保正确处理数据库连接和异常

## 项目结构

```
PoliceChainSystem/
├── app.py                     # 应用入口点
├── start.py                   # 快速启动脚本
├── views.py                   # Web界面视图函数
├── models.py                  # 数据模型
├── init_db.py                 # 数据库初始化
├── PoliceBlockchain.py        # 区块链交互
├── PoliceDataUpload.py        # 数据上传处理
├── PoliceDataVerification.py  # 数据验证
├── PoliceDataRevoke.py        # 数据撤销
├── PoliceTemplatePDF.py       # PDF生成
├── ipfs_utils.py              # IPFS工具
├── merkleUtils.py             # 默克尔树工具
├── contract_manager.py        # 智能合约管理
├── deploy_contracts.py        # 合约部署工具
├── contracts/                 # 智能合约目录
│   ├── PoliceRecordContract.sol   # 警情记录合约
│   ├── AuditTrailContract.sol     # 审计跟踪合约
│   └── contract_addresses.json    # 已部署合约地址
├── data_view/                 # 数据可视化模块
│   ├── app.py                     # 数据可视化后端
│   ├── templates/                 # 数据可视化模板
│   │   └── demo.html              # 数据可视化大屏
│   └── static/                    # 数据可视化静态资源
├── templates/                 # HTML模板
├── static/                    # 静态资源
├── database/                  # 数据库目录
├── police_records/            # 警情记录目录
├── upload/                    # 上传文件目录
└── requirements.txt           # 依赖清单
```

## 贡献指南

欢迎贡献代码和提出问题。请遵循以下步骤:

1. Fork项目仓库
2. 创建特性分支
3. 提交更改
4. 创建Pull Request

## 许可证

本项目采用 MIT 许可证。详情请参阅 LICENSE 文件。

## 联系方式

如有问题或建议，请联系项目维护者：

- 邮箱：support@policechain.com
- 官网：https://www.policechain.com

## 更新日志

### v1.0.0 (2023-05-01)
- 初始版本发布
- 基本功能实现：数据上链、验证、撤销

### v1.1.0 (2023-07-15)
- 添加数据可视化大屏功能
- 优化用户界面体验
- 完善文档和使用说明

### v1.2.0 (2023-11-10)
- 增加实时数据API
- 优化数据可视化性能
- 添加动态更新功能

### v1.3.0 (2023-12-25)
- 优化警情记录撤销流程
- 增强审计记录功能，区分操作成功和失败
- 修复警告记录统计问题

## 警情记录撤销流程

警情记录撤销功能是本系统的重要组成部分，确保错误或不需要的记录可被妥善处理。撤销流程包含以下步骤：

1. **撤销信息录入**：用户提供要撤销的警情记录编号和撤销原因。
2. **撤销信息上链存证**：系统将撤销信息提交到区块链网络，通过智能合约进行存证，确保撤销操作不可篡改且可追溯。
3. **撤销信息同步到本地数据库**：在撤销信息成功上链后，系统将撤销信息同步写入到本地数据库，更新记录状态为"已撤销"。
4. **审计记录生成**：系统自动生成撤销操作的审计记录，记录操作的详细信息，包括操作用户、时间、原因等。
5. **用户通知**：系统向用户反馈撤销结果，确保操作透明可追踪。

这一流程设计确保了数据撤销操作的安全性和完整性，同时通过区块链技术保证了操作的不可篡改性。 